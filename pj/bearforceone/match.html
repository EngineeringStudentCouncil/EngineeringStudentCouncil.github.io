<!DOCTYPE html>
<html>
  <head>
<!--     <meta charset="UTF-8" />
 -->    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="js/jquery.min.js"></script>
		<script src="js/supporters.js"></script>
<script src="pubnub/pubnub.js"></script>
		<script src="js/underscore.js"></script>

    <script src="sinch.min.js"></script>

    <link rel="stylesheet" href="../2/css/style.css" media="screen" type="text/css" />
    <link rel="stylesheet" href="../2/css/fontawesome.css" media="screen" type="text/css" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <script>

// transition fade in
  $(document).ready(function() {
      $('body').hide();
       $('body').fadeIn(800);
});


//sinch setup
sinchClient = new SinchClient({
	applicationKey: 'e8d034dd-0b5d-47d1-b230-335f684f0e77',
    capabilities: {messaging: true, calling: true},
  	onLogMessage: function(message) {
		console.log(message);
	},
});

sinchClient.start({username: 'marwahaha', password: 'test'}, function() {console.log("calling working!")}, function() {console.log("calling didn't work :(")});

callClient = sinchClient.getCallClient();


var callListeners = {
    onCallProgressing: function(call) {
        $('audio#ringback').prop("currentTime",0); //Ensure ringback start from beginning
        $('audio#ringback').trigger("play"); //Play ringback when call is progressing
    },
    onCallEstablished: function(call) {
        $('audio#ringback').trigger("pause"); //End ringback
        $('audio#incoming').attr('src', call.incomingStreamURL); //Connect incoming stream to audio element
    },
    onCallEnded: function(call) {
        $('audio#ringback').trigger("pause"); //End the ringback
        $('audio#incoming').attr('src', ''); //Ensure no incoming stream is playing
        //Optional: Enable user interface to make another call
    }
}
curcall = false;
function calling(number) {
  curcall = callClient.callPhoneNumber(number);
  curcall.addEventListener(callListeners);
}
function hangup() {
  curcall.hangup();
}


</script>
  </head>
  <body>
    <div id="zachstuff">
      <div class="main-contain">
    	<audio id="ringback" src='ringback.wav' loop></audio>
          <audio id="incoming" autoplay></audio>



        </div>
        
    </div>
    <script>
      addmatches();
    </script>
    
    
    
    
    
    <!--pubnub-->
    
<input id="name">
<br>&nbsp;<br>
<div id="talktome">

</div>
<br>&nbsp;<br>
<div id="onlyiftalking" style="display:none">
    <input id="client">
    <br>&nbsp;
    <br>
    <div id="messages">
        <div>Message board: <strong><span id="mb-title">None chosen</span></strong>
        </div>
        <button id="stoptalking" onclick='stoptalking()'>stop talking</button>
    </div>
</div>

    <!-- pubnub code -->
<script type="text/javascript">
    online_hosts = [];
    var cur_channel = "";
    function change_channel() {
        // $("#mb-title").html(cur_channel);
        // $('.msgs').remove();
    };

    var PUBNUB_demo = PUBNUB.init({
        publish_key: 'demo',
        subscribe_key: 'demo',
        uuid: "client-" + Math.random().toString(),
    });

    PUBNUB_demo.subscribe({
        heartbeat: 6,
        presence: function(m) {
            handlepresence(m);
            console.log(m)
        },

        channel: 'accenture-bf1-main',
        message: function(m) {
            console.log(m);
        }
    });

    $("#client").keyup(function(e) {
        if (e.keyCode == 13) {
            msgme($("#client").val());
            $("#client").val("");
        }
    });

    function msgme(text) {
        PUBNUB_demo.publish({
            channel: cur_channel,
            message: {
                "text": text,
                "sender": $("#name").val() || "anon"
            }
        });
    };

    function handlepresence(event) {
        if (event.uuid.lastIndexOf("supporter", 0) === 0) {
            var supporter_name = event.uuid.substring(10);
            if (event.action == "join") {
                console.log("supporter joined!");
                $("#talktome").append("<p id=talk-" + supporter_name + "> Talk to " + supporter_name + ".<button onclick='starttalking(\"" + supporter_name + "\")'>start talking</button><br></p>");
            }
            
              var pothosts = _.filter(info.curhosts, {'name': supporter_name});
              if (pothosts.length > 0) {
                pothosts[0].online = true;
              }
            if (event.action == "leave" || event.action == "timeout") {
                console.log("removing: " + supporter_name);
                $("#talktome").children("#talk-" + supporter_name).remove();
            
                
                  var pothosts = _.filter(info.curhosts, {'name': supporter_name});
                  if (pothosts.length > 0) {
                  pothosts[0].online = false;
                }
            }
        }
    }


    function stoptalking() {
        $("#talktome").show();
        $("#onlyiftalking").hide();
        PUBNUB_demo.unsubscribe({
            channel: cur_channel,
        });
        cur_channel = "";
    }


    function convohandle(event) {
        if (event.uuid.lastIndexOf("supporter", 0) === 0) {
            if (event.action == "join") {

                console.log("someone joined!");

                $("#messages").append("<i><p class='msgs'> User connected.</p></i>");

            };
            if (event.action == "leave" || event.action == "timeout") {
                console.log("someone left!");

                $("#messages").append("<i><p class='msgs'> User disconnected.</p></i>");
                PUBNUB_demo.unsubscribe({
                    channel: cur_channel,
                });
                cur_channel = "";
            };
        }

    }



    function joinmain() {
        PUBNUB_demo.subscribe({
            heartbeat: 6,
            presence: function(m) {
                handlepresence(m);
                // console.log(m)
            },

            channel: 'accenture-bf1-main',
            message: function(m) {
                console.log(m);
            }
        });

    }

    function starttalking(channel) {
        $("#talktome").hide();
        $("#onlyiftalking").show();
        PUBNUB_demo.unsubscribe({
            channel: cur_channel,
        });
        PUBNUB_demo.subscribe({
            heartbeat: 6,
            presence: function(m) {
                convohandle(m);
                // console.log(m)

            },

            channel: channel,
            message: function(m) {
                console.log(m);
                $("#messages").append("<p class='msgs'>" + m.text + " - " + m.sender + "</p>");

            }
        });
        cur_channel = channel;
        change_channel();
    }
</script>
</body>
</html>